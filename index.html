<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éï„Ç°„É≥„ÇØ„É©„Éñ „Éù„Çπ„Éà„Ç´„Éº„ÉâÈÖçÂ∏ÉÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            color: #666;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        
        .mode-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .test-mode-indicator {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .date-group {
            margin-bottom: 15px;
        }
        
        .date-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .date-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .current-event {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .current-event h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-mode-switch {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
            display: none;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .stats {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-weight: 500;
            color: #555;
        }
        
        .stats-value {
            font-weight: 600;
            color: #333;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .member-id {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .clear-btn {
            background: #dc3545;
            font-size: 14px;
            padding: 8px 15px;
            margin-top: 10px;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .export-btn {
            background: #28a745;
            font-size: 14px;
            padding: 8px 15px;
            margin-top: 10px;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .export-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .qr-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        #qrReader {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }
        
        #qrReader video {
            width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé´ „Éù„Çπ„Éà„Ç´„Éº„ÉâÈÖçÂ∏ÉÁÆ°ÁêÜ</h1>
        
        <!-- „É¢„Éº„ÉâÈÅ∏Êäû -->
        <div class="mode-selector">
            <button class="mode-btn active" id="productionBtn" onclick="switchToProduction()">Êú¨Áï™„É¢„Éº„Éâ</button>
            <button class="mode-btn" id="testBtn" onclick="switchToTest()">„ÉÜ„Çπ„Éà„É¢„Éº„Éâ</button>
        </div>
        
        <!-- „ÉÜ„Çπ„Éà„É¢„Éº„ÉâË°®Á§∫ -->
        <div class="test-mode-indicator" id="testModeIndicator">
            üß™ „ÉÜ„Çπ„Éà„É¢„Éº„Éâ - „Åì„ÅÆ„É¢„Éº„Éâ„Åß„ÅØÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Å´ÂΩ±Èüø„Åó„Åæ„Åõ„Çì
        </div>
        
        <!-- „Çø„Éñ„É°„Éã„É•„Éº -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('distribution')">ÈÖçÂ∏ÉÁÆ°ÁêÜ</button>
            <button class="tab" onclick="showTab('settings')">Ë®≠ÂÆö</button>
        </div>
        
        <!-- ÈÖçÂ∏ÉÁÆ°ÁêÜ„Çø„Éñ -->
        <div class="tab-content active" id="distribution">
            <!-- ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„ÉàÊÉÖÂ†± -->
            <div class="current-event" id="currentEvent">
                <h3>üìÖ ÁèæÂú®„ÅÆ„Ç§„Éô„É≥„Éà</h3>
                <div id="eventInfo">Ë®≠ÂÆö„Çø„Éñ„Åß„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
            
            <div class="stats">
                <div class="stats-row">
                    <span class="stats-label">Êú¨Êó•„ÅÆÈÖçÂ∏ÉÊ∏à„ÅøÊûöÊï∞Ôºö</span>
                    <span class="stats-value" id="todayCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Á∑èÈÖçÂ∏ÉÊ∏à„ÅøÊûöÊï∞Ôºö</span>
                    <span class="stats-value" id="totalCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">ÊúÄÂæå„ÅÆÈÖçÂ∏ÉÊôÇÂàªÔºö</span>
                    <span class="stats-value" id="lastTime">Êú™ÈÖçÂ∏É</span>
                </div>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            <div class="warning" id="warningMessage"></div>
            
            <!-- ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø -->
            <div class="input-mode-switch">
                <button type="button" class="mode-btn active" id="manualBtn" onclick="switchToManual()">ÊâãÂãïÂÖ•Âäõ</button>
                <button type="button" class="mode-btn" id="qrBtn" onclick="switchToQR()">QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä</button>
            </div>
            
            <form id="memberForm">
                <div class="form-group" id="manualInput">
                    <label for="memberId">‰ºöÂì°Áï™Âè∑</label>
                    <input type="text" id="memberId" name="memberId" placeholder="‰ºöÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
                </div>
                
                <div class="form-group" id="qrInput" style="display: none;">
                    <label>QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä</label>
                    <div id="qrReader" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                    <div id="qrStatus" class="qr-status">„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...</div>
                    <button type="button" class="btn" id="startQrBtn" onclick="startQRScanner()" style="display: none;">QR„Çπ„Ç≠„É£„É≥ÈñãÂßã</button>
                    <button type="button" class="btn" id="stopQrBtn" onclick="stopQRScanner()" style="display: none;">QR„Çπ„Ç≠„É£„É≥ÂÅúÊ≠¢</button>
                </div>
                
                <button type="submit" class="btn">„Éù„Çπ„Éà„Ç´„Éº„ÉâÈÖçÂ∏É</button>
            </form>
            
            <div class="form-group">
                <label>ÈÖçÂ∏ÉÂ±•Ê≠¥</label>
                <div class="history" id="history">
                    <div style="text-align: center; color: #666; font-style: italic;">
                        „Åæ„Å†ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                </div>
                <button type="button" class="btn clear-btn" onclick="clearHistory()">Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢</button>
                <button type="button" class="btn export-btn" onclick="exportCSV()">CSVÂá∫Âäõ</button>
                <button type="button" class="btn export-btn" onclick="exportText()">„ÉÜ„Ç≠„Çπ„ÉàÂá∫Âäõ</button>
            </div>
            
            <div class="export-section">
                <div class="export-title">üìä „Éá„Éº„ÇøÂá∫Âäõ</div>
                <div class="export-options">
                    <button type="button" class="btn export-btn" onclick="exportDetailedCSV()">Ë©≥Á¥∞CSVÂá∫Âäõ</button>
                    <button type="button" class="btn export-btn" onclick="exportMemberListOnly()">‰ºöÂì°Áï™Âè∑„ÅÆ„ÅøÂá∫Âäõ</button>
                    <button type="button" class="btn export-btn" onclick="copyToClipboard()">„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
                </div>
            </div>
        </div>
        
        <!-- Ë®≠ÂÆö„Çø„Éñ -->
        <div class="tab-content" id="settings">
            <div class="date-settings">
                <h3>üìÖ „Ç§„Éô„É≥„ÉàË®≠ÂÆö</h3>
                
                <div class="date-group">
                    <label for="eventName">„Ç§„Éô„É≥„ÉàÂêç</label>
                    <input type="text" id="eventName" placeholder="‰æãÔºö2025Âπ¥Êò•„É©„Ç§„Éñ">
                </div>
                
                <div class="date-group">
                    <label for="eventDate">„Ç§„Éô„É≥„ÉàÊó•‰ªò</label>
                    <input type="date" id="eventDate">
                </div>
                
                <div class="date-group">
                    <label for="eventVenue">‰ºöÂ†¥Âêç</label>
                    <input type="text" id="eventVenue" placeholder="‰æãÔºöÊù±‰∫¨„Éâ„Éº„É†">
                </div>
                
                <button type="button" class="btn" onclick="saveEventSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
            </div>
            
            <div class="date-settings">
                <h3>‚öôÔ∏è „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö</h3>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="strictDateCheck"> 
                        Âé≥ÂØÜ„Å™Êó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç§„Éô„É≥„ÉàÊó•‰ª•Â§ñ„ÅØÈÖçÂ∏É„ÇíÂà∂ÈôêÔºâ
                    </label>
                </div>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="allowDuplicateInTest"> 
                        „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„ÅßÈáçË§á„ÇíË®±ÂèØ
                    </label>
                </div>
                
                <button type="button" class="btn" onclick="saveSystemSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let distributedMembers = [];
        let testDistributedMembers = [];
        let html5QrCode = null;
        let isQRMode = false;
        let isTestMode = false;
        let eventSettings = {
            name: '',
            date: '',
            venue: ''
        };
        let systemSettings = {
            strictDateCheck: false,
            allowDuplicateInTest: false
        };
        
        // DOMË¶ÅÁ¥†
        const form = document.getElementById('memberForm');
        const memberIdInput = document.getElementById('memberId');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const warningMessage = document.getElementById('warningMessage');
        const todayCount = document.getElementById('todayCount');
        const totalCount = document.getElementById('totalCount');
        const lastTime = document.getElementById('lastTime');
        const history = document.getElementById('history');
        const manualInput = document.getElementById('manualInput');
        const qrInput = document.getElementById('qrInput');
        const qrStatus = document.getElementById('qrStatus');
        const startQrBtn = document.getElementById('startQrBtn');
        const stopQrBtn = document.getElementById('stopQrBtn');
        const manualBtn = document.getElementById('manualBtn');
        const qrBtn = document.getElementById('qrBtn');
        const testModeIndicator = document.getElementById('testModeIndicator');
        const productionBtn = document.getElementById('productionBtn');
        const testBtn = document.getElementById('testBtn');
        const currentEvent = document.getElementById('currentEvent');
        const eventInfo = document.getElementById('eventInfo');
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateEventDisplay();
            updateStats();
            updateHistory();
            memberIdInput.focus();
        });
        
        // Ë®≠ÂÆöË™≠„ÅøËæº„Åø
        function loadSettings() {
            const savedEventSettings = localStorage.getItem('eventSettings');
            const savedSystemSettings = localStorage.getItem('systemSettings');
            const savedDistributedMembers = localStorage.getItem('distributedMembers');
            const savedTestDistributedMembers = localStorage.getItem('testDistributedMembers');
            
            if (savedEventSettings) {
                eventSettings = JSON.parse(savedEventSettings);
                document.getElementById('eventName').value = eventSettings.name || '';
                document.getElementById('eventDate').value = eventSettings.date || '';
                document.getElementById('eventVenue').value = eventSettings.venue || '';
            }
            
            if (savedSystemSettings) {
                systemSettings = JSON.parse(savedSystemSettings);
                document.getElementById('strictDateCheck').checked = systemSettings.strictDateCheck || false;
                document.getElementById('allowDuplicateInTest').checked = systemSettings.allowDuplicateInTest || false;
            }
            
            if (savedDistributedMembers) {
                distributedMembers = JSON.parse(savedDistributedMembers);
            }
            
            if (savedTestDistributedMembers) {
                testDistributedMembers = JSON.parse(savedTestDistributedMembers);
            }
        }
        
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }
        
        // Êú¨Áï™„É¢„Éº„Éâ/„ÉÜ„Çπ„Éà„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function switchToProduction() {
            isTestMode = false;
            productionBtn.classList.add('active');
            testBtn.classList.remove('active');
            testModeIndicator.style.display = 'none';
            updateStats();
            updateHistory();
        }
        
        function switchToTest() {
            isTestMode = true;
            productionBtn.classList.remove('active');
            testBtn.classList.add('active');
            testModeIndicator.style.display = 'block';
            updateStats();
            updateHistory();
        }
        
        // ÊâãÂãïÂÖ•Âäõ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        function switchToManual() {
            isQRMode = false;
            manualInput.style.display = 'block';
            qrInput.style.display = 'none';
            manualBtn.classList.add('active');
            qrBtn.classList.remove('active');
            
            if (html5QrCode) {
                stopQRScanner();
            }
            
            memberIdInput.focus();
            hideMessages();
        }
        
        // QR„Ç≥„Éº„Éâ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        function switchToQR() {
            isQRMode = true;
            manualInput.style.display = 'none';
            qrInput.style.display = 'block';
            manualBtn.classList.remove('active');
            qrBtn.classList.add('active');
            
            hideMessages();
            startQRScanner();
        }
        
        // QR„Çπ„Ç≠„É£„Éä„ÉºÈñãÂßã
        function startQRScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qrReader");
            }
            
            qrStatus.textContent = "„Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...";
            startQrBtn.style.display = 'none';
            stopQrBtn.style.display = 'block';
            
            const qrConfig = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                qrConfig,
                (decodedText, decodedResult) => {
                    qrStatus.textContent = `Ë™≠„ÅøÂèñ„ÇäÊàêÂäü: ${decodedText}`;
                    processMemberRegistration(decodedText);
                },
                (errorMessage) => {
                    // „Ç®„É©„Éº„ÅØÈÄöÂ∏∏„ÅÆ„Çπ„Ç≠„É£„É≥‰∏≠„ÅÆ„Ç®„É©„Éº„Å™„ÅÆ„ÅßÁÑ°Ë¶ñ
                }
            ).then(() => {
                qrStatus.textContent = "QR„Ç≥„Éº„Éâ„Çí„Ç´„É°„É©„Å´Âêë„Åë„Å¶„Åè„Å†„Åï„ÅÑ";
            }).catch(err => {
                qrStatus.textContent = "„Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
                startQrBtn.style.display = 'block';
                stopQrBtn.style.display = 'none';
                console.error("QR„Çπ„Ç≠„É£„Éä„ÉºÈñãÂßã„Ç®„É©„Éº:", err);
            });
        }
        
        // QR„Çπ„Ç≠„É£„Éä„ÉºÂÅúÊ≠¢
        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    qrStatus.textContent = "QR„Çπ„Ç≠„É£„É≥„ÅåÂÅúÊ≠¢„Åï„Çå„Åæ„Åó„Åü";
                    startQrBtn.style.display = 'block';
                    stopQrBtn.style.display = 'none';
                }).catch(err => {
                    console.error("QR„Çπ„Ç≠„É£„Éä„ÉºÂÅúÊ≠¢„Ç®„É©„Éº:", err);
                });
            }
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        function showWarning(message) {
            warningMessage.textContent = message;
            warningMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        // ÁèæÂú®„ÅÆÊôÇÂàª„ÇíÂèñÂæó
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíÂèñÂæó
        function getTodayString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        // „Ç§„Éô„É≥„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateEventDisplay() {
            if (eventSettings.name || eventSettings.date || eventSettings.venue) {
                let info = '';
                if (eventSettings.name) info += `„Ç§„Éô„É≥„ÉàÂêç: ${eventSettings.name}<br>`;
                if (eventSettings.date) info += `Êó•‰ªò: ${eventSettings.date}<br>`;
                if (eventSettings.venue) info += `‰ºöÂ†¥: ${eventSettings.venue}`;
                eventInfo.innerHTML = info;
            } else {
                eventInfo.textContent = 'Ë®≠ÂÆö„Çø„Éñ„Åß„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            }
        }
        
        // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        function updateStats() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            todayCount.textContent = todayData.length;
            totalCount.textContent = currentData.length;
            
            if (currentData.length > 0) {
                lastTime.textContent = currentData[currentData.length - 1].timestamp;
            } else {
                lastTime.textContent = 'Êú™ÈÖçÂ∏É';
            }
        }
        
        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
        function updateHistory() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            
            if (currentData.length === 0) {
                history.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">„Åæ„Å†ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            history.innerHTML = '';
            currentData.slice().reverse().forEach(member => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <span class="member-id">${member.id}</span>
                    <span class="timestamp">${member.timestamp}</span>
                `;
                history.appendChild(item);
            });
        }
        
        // Êó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØ
        function checkEventDate() {
            if (!systemSettings.strictDateCheck || !eventSettings.date) {
                return true;
            }
            
            const today = getTodayString();
            return today === eventSettings.date;
        }
        
        // ‰ºöÂì°ÁôªÈå≤Âá¶ÁêÜ
        function processMemberRegistration(memberId) {
            if (!memberId || !memberId.trim()) {
                showError('‰ºöÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            const cleanMemberId = memberId.trim();
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const today = getTodayString();
            
            // Êó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØ
            if (!checkEventDate()) {
                showWarning(`Êú¨Êó•Ôºà${today}Ôºâ„ÅØ„Ç§„Éô„É≥„ÉàÊó•Ôºà${eventSettings.date}Ôºâ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÈÖçÂ∏É„ÇíÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÅãÔºü`);
            }
            
            // 1Êó•1ÂõûÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
            const todayDistribution = currentData.find(member => 
                member.id === cleanMemberId && member.date === today
            );
            
            if (todayDistribution) {
                showError(`‰ºöÂì°Áï™Âè∑ ${cleanMemberId} „ÅØÊú¨Êó•Êó¢„Å´„Éù„Çπ„Éà„Ç´„Éº„Éâ„ÇíÂèó„ÅëÂèñ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÔºàÈÖçÂ∏ÉÊôÇÂàª: ${todayDistribution.timestamp}Ôºâ`);
                return;
            }
            
            // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Åß„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            if (isTestMode && !systemSettings.allowDuplicateInTest) {
                const isDuplicate = currentData.some(member => member.id === cleanMemberId);
                if (isDuplicate) {
                    showError(`‰ºöÂì°Áï™Âè∑ ${cleanMemberId} „ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÔºà„ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºâ`);
                    return;
                }
            }
            
            // ÈÖçÂ∏ÉÂá¶ÁêÜ
            const memberData = {
                id: cleanMemberId,
                timestamp: getCurrentTime(),
                date: today,
                testMode: isTestMode
            };
            
            if (isTestMode) {
                testDistributedMembers.push(memberData);
                localStorage.setItem('testDistributedMembers', JSON.stringify(testDistributedMembers));
            } else {
                distributedMembers.push(memberData);
                localStorage.setItem('distributedMembers', JSON.stringify(distributedMembers));
            }
            
            // ÁîªÈù¢Êõ¥Êñ∞
            updateStats();
            updateHistory();
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            const modeText = isTestMode ? 'Ôºà„ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºâ' : '';
            showSuccess(`‰ºöÂì°Áï™Âè∑ ${cleanMemberId} „Å´„Éù„Çπ„Éà„Ç´„Éº„Éâ„ÇíÈÖçÂ∏É„Åó„Åæ„Åó„Åü„ÄÇ${modeText}`);
            
            // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
            if (!isQRMode) {
                memberIdInput.value = '';
                memberIdInput.focus();
            }
        }
        
        // „Ç§„Éô„É≥„ÉàË®≠ÂÆö‰øùÂ≠ò
        function saveEventSettings() {
            eventSettings.name = document.getElementById('eventName').value;
            eventSettings.date = document.getElementById('eventDate').value;
            eventSettings.venue = document.getElementById('eventVenue').value;
            
            localStorage.setItem('eventSettings', JSON.stringify(eventSettings));
            updateEventDisplay();
            showSuccess('„Ç§„Éô„É≥„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö‰øùÂ≠ò
        function saveSystemSettings() {
            systemSettings.strictDateCheck = document.getElementById('strictDateCheck').checked;
            systemSettings.allowDuplicateInTest = document.getElementById('allowDuplicateInTest').checked;
            
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            showSuccess('„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
        function clearHistory() {
            const modeText = isTestMode ? '„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„ÅÆ' : '';
            if (confirm(`${modeText}ÈÖçÂ∏ÉÂ±•Ê≠¥„Çí„Åô„Åπ„Å¶„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü`)) {
                if (isTestMode) {
                    testDistributedMembers = [];
                    localStorage.setItem('testDistributedMembers', JSON.stringify(testDistributedMembers));
                } else {
                    distributedMembers = [];
                    localStorage.setItem('distributedMembers', JSON.stringify(distributedMembers));
                }
                
                updateStats();
                updateHistory();
                hideMessages();
                showSuccess(`${modeText}ÈÖçÂ∏ÉÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ`);
            }
        }
        
        // CSV„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function exportCSV() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const csvContent = generateCSVContent();
            const fileName = isTestMode ? 'postcard_distribution_test.csv' : 'postcard_distribution.csv';
            downloadFile(csvContent, fileName, 'text/csv');
            showSuccess('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // Ë©≥Á¥∞CSV„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function exportDetailedCSV() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const csvContent = generateDetailedCSVContent();
            const fileName = isTestMode ? 'postcard_distribution_detailed_test.csv' : 'postcard_distribution_detailed.csv';
            downloadFile(csvContent, fileName, 'text/csv');
            showSuccess('Ë©≥Á¥∞CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function exportText() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const textContent = generateTextContent();
            const fileName = isTestMode ? 'postcard_distribution_test.txt' : 'postcard_distribution.txt';
            downloadFile(textContent, fileName, 'text/plain');
            showSuccess('„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // ‰ºöÂì°Áï™Âè∑„ÅÆ„Åø„ÇíÂá∫Âäõ
        function exportMemberListOnly() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const memberIds = currentData.map(member => member.id).join('\n');
            const fileName = isTestMode ? 'member_ids_only_test.txt' : 'member_ids_only.txt';
            downloadFile(memberIds, fileName, 'text/plain');
            showSuccess('‰ºöÂì°Áï™Âè∑„É™„Çπ„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ');
        }
        
        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyToClipboard() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('ÈÖçÂ∏ÉÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            
            const textContent = generateTextContent();
            navigator.clipboard.writeText(textContent).then(() => {
                showSuccess('ÈÖçÂ∏ÉÂ±•Ê≠¥„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ');
            }).catch(() => {
                showError('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            });
        }
        
        // CSVÂÜÖÂÆπ„ÇíÁîüÊàê
        function generateCSVContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const header = '‰ºöÂì°Áï™Âè∑,ÈÖçÂ∏ÉÊó•ÊôÇ,ÈÖçÂ∏ÉÊó•\n';
            const rows = currentData.map(member => 
                `${member.id},"${member.timestamp}","${member.date}"`
            ).join('\n');
            return header + rows;
        }
        
        // Ë©≥Á¥∞CSVÂÜÖÂÆπ„ÇíÁîüÊàê
        function generateDetailedCSVContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const currentTime = getCurrentTime();
            const modeText = isTestMode ? ' („ÉÜ„Çπ„Éà„É¢„Éº„Éâ)' : '';
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            const header = '‰ºöÂì°Áï™Âè∑,ÈÖçÂ∏ÉÊó•ÊôÇ,ÈÖçÂ∏ÉÊó•,ÈÖçÂ∏ÉÈ†ÜÂ∫è,„É¢„Éº„Éâ\n';
            const rows = currentData.map((member, index) => 
                `${member.id},"${member.timestamp}","${member.date}",${index + 1},${member.testMode ? '„ÉÜ„Çπ„Éà' : 'Êú¨Áï™'}`
            ).join('\n');
            
            let content = `# „Éù„Çπ„Éà„Ç´„Éº„ÉâÈÖçÂ∏ÉÂ±•Ê≠¥${modeText} - ${currentTime}\n`;
            content += `# „Ç§„Éô„É≥„ÉàÂêç: ${eventSettings.name || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `# „Ç§„Éô„É≥„ÉàÊó•: ${eventSettings.date || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `# ‰ºöÂ†¥: ${eventSettings.venue || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `# Êú¨Êó•„ÅÆÈÖçÂ∏ÉÊï∞: ${todayData.length}Êûö\n`;
            content += `# Á∑èÈÖçÂ∏ÉÊï∞: ${currentData.length}Êûö\n\n`;
            content += header + rows;
            
            return content;
        }
        
        // „ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ„ÇíÁîüÊàê
        function generateTextContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const currentTime = getCurrentTime();
            const modeText = isTestMode ? ' („ÉÜ„Çπ„Éà„É¢„Éº„Éâ)' : '';
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            let content = `„Éù„Çπ„Éà„Ç´„Éº„ÉâÈÖçÂ∏ÉÂ±•Ê≠¥${modeText}\n`;
            content += `Âá∫ÂäõÊó•ÊôÇ: ${currentTime}\n`;
            content += `„Ç§„Éô„É≥„ÉàÂêç: ${eventSettings.name || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `„Ç§„Éô„É≥„ÉàÊó•: ${eventSettings.date || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `‰ºöÂ†¥: ${eventSettings.venue || 'Êú™Ë®≠ÂÆö'}\n`;
            content += `Êú¨Êó•„ÅÆÈÖçÂ∏ÉÊï∞: ${todayData.length}Êûö\n`;
            content += `Á∑èÈÖçÂ∏ÉÊï∞: ${currentData.length}Êûö\n\n`;
            content += `--- ÈÖçÂ∏ÉÂ±•Ê≠¥ ---\n`;
            
            currentData.forEach((member, index) => {
                const mode = member.testMode ? ' („ÉÜ„Çπ„Éà)' : '';
                content += `${index + 1}. ‰ºöÂì°Áï™Âè∑: ${member.id} | ÈÖçÂ∏ÉÊó•ÊôÇ: ${member.timestamp} | Êó•‰ªò: ${member.date}${mode}\n`;
            });
            
            content += `\n--- ‰ºöÂì°Áï™Âè∑‰∏ÄË¶ß ---\n`;
            content += currentData.map(member => member.id).join('\n');
            
            return content;
        }
        
        // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isQRMode) {
                const memberId = memberIdInput.value.trim();
                processMemberRegistration(memberId);
            }
        });
        
        // ÂÖ•ÂäõÊôÇ„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈùûË°®Á§∫
        memberIdInput.addEventListener('input', hideMessages);
    </script>
</body>
</html>