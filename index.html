<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ãƒ³ã‚¯ãƒ©ãƒ– ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            color: #666;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        
        .mode-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .test-mode-indicator {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .date-group {
            margin-bottom: 15px;
        }
        
        .date-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .date-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        .current-event {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .current-event h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-mode-switch {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
            display: none;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .stats {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stats-label {
            font-weight: 500;
            color: #555;
        }
        
        .stats-value {
            font-weight: 600;
            color: #333;
        }
        
        .history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .member-id {
            font-weight: 600;
            color: #333;
        }
        
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .clear-btn {
            background: #dc3545;
            font-size: 14px;
            padding: 8px 15px;
            margin-top: 10px;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
        
        .export-btn {
            background: #28a745;
            font-size: 14px;
            padding: 8px 15px;
            margin-top: 10px;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .export-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .qr-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        #qrReader {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }
        
        #qrReader video {
            width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ« ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒç®¡ç†</h1>
        
        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div class="mode-selector">
            <button class="mode-btn active" id="productionBtn" onclick="switchToProduction()">æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰</button>
            <button class="mode-btn" id="testBtn" onclick="switchToTest()">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
        </div>
        
        <!-- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
        <div class="test-mode-indicator" id="testModeIndicator">
            ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã—ã¾ã›ã‚“
        </div>
        
        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('distribution')">é…å¸ƒç®¡ç†</button>
            <button class="tab" onclick="showTab('settings')">è¨­å®š</button>
        </div>
        
        <!-- é…å¸ƒç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-content active" id="distribution">
            <!-- ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± -->
            <div class="current-event" id="currentEvent">
                <h3>ğŸ“… ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
                <div id="eventInfo">è¨­å®šã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
            </div>
            
            <div class="stats">
                <div class="stats-row">
                    <span class="stats-label">æœ¬æ—¥ã®é…å¸ƒæ¸ˆã¿æšæ•°ï¼š</span>
                    <span class="stats-value" id="todayCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">ç·é…å¸ƒæ¸ˆã¿æšæ•°ï¼š</span>
                    <span class="stats-value" id="totalCount">0</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">æœ€å¾Œã®é…å¸ƒæ™‚åˆ»ï¼š</span>
                    <span class="stats-value" id="lastTime">æœªé…å¸ƒ</span>
                </div>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            <div class="warning" id="warningMessage"></div>
            
            <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
            <div class="input-mode-switch">
                <button type="button" class="mode-btn active" id="manualBtn" onclick="switchToManual()">æ‰‹å‹•å…¥åŠ›</button>
                <button type="button" class="mode-btn" id="qrBtn" onclick="switchToQR()">QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</button>
            </div>
            
            <form id="memberForm">
                <div class="form-group" id="manualInput">
                    <label for="memberId">ä¼šå“¡ç•ªå·</label>
                    <input type="text" id="memberId" name="memberId" placeholder="ä¼šå“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
                </div>
                
                <div class="form-group" id="qrInput" style="display: none;">
                    <label>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</label>
                    <div id="qrReader" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
                    <div id="qrStatus" class="qr-status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
                    <button type="button" class="btn" id="startQrBtn" onclick="startQRScanner()" style="display: none;">QRã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
                    <button type="button" class="btn" id="stopQrBtn" onclick="stopQRScanner()" style="display: none;">QRã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
                </div>
                
                <button type="submit" class="btn">ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒ</button>
            </form>
            
            <div class="form-group">
                <label>é…å¸ƒå±¥æ­´</label>
                <div class="history" id="history">
                    <div style="text-align: center; color: #666; font-style: italic;">
                        ã¾ã é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
                <button type="button" class="btn clear-btn" onclick="clearHistory()">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
                <button type="button" class="btn export-btn" onclick="exportCSV()">CSVå‡ºåŠ›</button>
                <button type="button" class="btn export-btn" onclick="exportText()">ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
            </div>
            
            <div class="export-section">
                <div class="export-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</div>
                <div class="export-options">
                    <button type="button" class="btn export-btn" onclick="exportDetailedCSV()">è©³ç´°CSVå‡ºåŠ›</button>
                    <button type="button" class="btn export-btn" onclick="exportMemberListOnly()">ä¼šå“¡ç•ªå·ã®ã¿å‡ºåŠ›</button>
                    <button type="button" class="btn export-btn" onclick="copyToClipboard()">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
        </div>
        
        <!-- è¨­å®šã‚¿ãƒ– -->
        <div class="tab-content" id="settings">
            <div class="date-settings">
                <h3>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h3>
                
                <div class="date-group">
                    <label for="eventName">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                    <input type="text" id="eventName" placeholder="ä¾‹ï¼š2025å¹´æ˜¥ãƒ©ã‚¤ãƒ–">
                </div>
                
                <div class="date-group">
                    <label for="eventDate">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»˜</label>
                    <input type="date" id="eventDate">
                </div>
                
                <div class="date-group">
                    <label for="eventVenue">ä¼šå ´å</label>
                    <input type="text" id="eventVenue" placeholder="ä¾‹ï¼šæ±äº¬ãƒ‰ãƒ¼ãƒ ">
                </div>
                
                <button type="button" class="btn" onclick="saveEventSettings()">è¨­å®šã‚’ä¿å­˜</button>
            </div>
            
            <div class="date-settings">
                <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="strictDateCheck"> 
                        å³å¯†ãªæ—¥ä»˜ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæ—¥ä»¥å¤–ã¯é…å¸ƒã‚’åˆ¶é™ï¼‰
                    </label>
                </div>
                
                <div class="date-group">
                    <label>
                        <input type="checkbox" id="allowDuplicateInTest"> 
                        ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é‡è¤‡ã‚’è¨±å¯
                    </label>
                </div>
                
                <button type="button" class="btn" onclick="saveSystemSettings()">è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let distributedMembers = [];
        let testDistributedMembers = [];
        let html5QrCode = null;
        let isQRMode = false;
        let isTestMode = false;
        let eventSettings = {
            name: '',
            date: '',
            venue: ''
        };
        let systemSettings = {
            strictDateCheck: false,
            allowDuplicateInTest: false
        };
        
        // DOMè¦ç´ 
        const form = document.getElementById('memberForm');
        const memberIdInput = document.getElementById('memberId');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const warningMessage = document.getElementById('warningMessage');
        const todayCount = document.getElementById('todayCount');
        const totalCount = document.getElementById('totalCount');
        const lastTime = document.getElementById('lastTime');
        const history = document.getElementById('history');
        const manualInput = document.getElementById('manualInput');
        const qrInput = document.getElementById('qrInput');
        const qrStatus = document.getElementById('qrStatus');
        const startQrBtn = document.getElementById('startQrBtn');
        const stopQrBtn = document.getElementById('stopQrBtn');
        const manualBtn = document.getElementById('manualBtn');
        const qrBtn = document.getElementById('qrBtn');
        const testModeIndicator = document.getElementById('testModeIndicator');
        const productionBtn = document.getElementById('productionBtn');
        const testBtn = document.getElementById('testBtn');
        const currentEvent = document.getElementById('currentEvent');
        const eventInfo = document.getElementById('eventInfo');
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateEventDisplay();
            updateStats();
            updateHistory();
            memberIdInput.focus();
        });
        
        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            const savedEventSettings = localStorage.getItem('eventSettings');
            const savedSystemSettings = localStorage.getItem('systemSettings');
            const savedDistributedMembers = localStorage.getItem('distributedMembers');
            const savedTestDistributedMembers = localStorage.getItem('testDistributedMembers');
            
            if (savedEventSettings) {
                eventSettings = JSON.parse(savedEventSettings);
                document.getElementById('eventName').value = eventSettings.name || '';
                document.getElementById('eventDate').value = eventSettings.date || '';
                document.getElementById('eventVenue').value = eventSettings.venue || '';
            }
            
            if (savedSystemSettings) {
                systemSettings = JSON.parse(savedSystemSettings);
                document.getElementById('strictDateCheck').checked = systemSettings.strictDateCheck || false;
                document.getElementById('allowDuplicateInTest').checked = systemSettings.allowDuplicateInTest || false;
            }
            
            if (savedDistributedMembers) {
                distributedMembers = JSON.parse(savedDistributedMembers);
            }
            
            if (savedTestDistributedMembers) {
                testDistributedMembers = JSON.parse(savedTestDistributedMembers);
            }
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }
        
        // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰/ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchToProduction() {
            isTestMode = false;
            productionBtn.classList.add('active');
            testBtn.classList.remove('active');
            testModeIndicator.style.display = 'none';
            updateStats();
            updateHistory();
        }
        
        function switchToTest() {
            isTestMode = true;
            productionBtn.classList.remove('active');
            testBtn.classList.add('active');
            testModeIndicator.style.display = 'block';
            updateStats();
            updateHistory();
        }
        
        // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        function switchToManual() {
            isQRMode = false;
            manualInput.style.display = 'block';
            qrInput.style.display = 'none';
            manualBtn.classList.add('active');
            qrBtn.classList.remove('active');
            
            if (html5QrCode) {
                stopQRScanner();
            }
            
            memberIdInput.focus();
            hideMessages();
        }
        
        // QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        function switchToQR() {
            isQRMode = true;
            manualInput.style.display = 'none';
            qrInput.style.display = 'block';
            manualBtn.classList.remove('active');
            qrBtn.classList.add('active');
            
            hideMessages();
            startQRScanner();
        }
        
        // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹
        function startQRScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qrReader");
            }
            
            qrStatus.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
            startQrBtn.style.display = 'none';
            stopQrBtn.style.display = 'block';
            
            const qrConfig = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                qrConfig,
                (decodedText, decodedResult) => {
                    qrStatus.textContent = `èª­ã¿å–ã‚ŠæˆåŠŸ: ${decodedText}`;
                    processMemberRegistration(decodedText);
                },
                (errorMessage) => {
                    // ã‚¨ãƒ©ãƒ¼ã¯é€šå¸¸ã®ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®ã‚¨ãƒ©ãƒ¼ãªã®ã§ç„¡è¦–
                }
            ).then(() => {
                qrStatus.textContent = "QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„";
            }).catch(err => {
                qrStatus.textContent = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ";
                startQrBtn.style.display = 'block';
                stopQrBtn.style.display = 'none';
                console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
            });
        }
        
        // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢
        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    qrStatus.textContent = "QRã‚¹ã‚­ãƒ£ãƒ³ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ";
                    startQrBtn.style.display = 'block';
                    stopQrBtn.style.display = 'none';
                }).catch(err => {
                    console.error("QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
                });
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        function showWarning(message) {
            warningMessage.textContent = message;
            warningMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            warningMessage.style.display = 'none';
        }
        
        // ç¾åœ¨ã®æ™‚åˆ»ã‚’å–å¾—
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        function getTodayString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        function updateEventDisplay() {
            if (eventSettings.name || eventSettings.date || eventSettings.venue) {
                let info = '';
                if (eventSettings.name) info += `ã‚¤ãƒ™ãƒ³ãƒˆå: ${eventSettings.name}<br>`;
                if (eventSettings.date) info += `æ—¥ä»˜: ${eventSettings.date}<br>`;
                if (eventSettings.venue) info += `ä¼šå ´: ${eventSettings.venue}`;
                eventInfo.innerHTML = info;
            } else {
                eventInfo.textContent = 'è¨­å®šã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„';
            }
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            todayCount.textContent = todayData.length;
            totalCount.textContent = currentData.length;
            
            if (currentData.length > 0) {
                lastTime.textContent = currentData[currentData.length - 1].timestamp;
            } else {
                lastTime.textContent = 'æœªé…å¸ƒ';
            }
        }
        
        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistory() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            
            if (currentData.length === 0) {
                history.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">ã¾ã é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            history.innerHTML = '';
            currentData.slice().reverse().forEach(member => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <span class="member-id">${member.id}</span>
                    <span class="timestamp">${member.timestamp}</span>
                `;
                history.appendChild(item);
            });
        }
        
        // æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
        function checkEventDate() {
            if (!systemSettings.strictDateCheck || !eventSettings.date) {
                return true;
            }
            
            const today = getTodayString();
            return today === eventSettings.date;
        }
        
        // ä¼šå“¡ç™»éŒ²å‡¦ç†
        function processMemberRegistration(memberId) {
            if (!memberId || !memberId.trim()) {
                showError('ä¼šå“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const cleanMemberId = memberId.trim();
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const today = getTodayString();
            
            // æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
            if (!checkEventDate()) {
                showWarning(`æœ¬æ—¥ï¼ˆ${today}ï¼‰ã¯ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ï¼ˆ${eventSettings.date}ï¼‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é…å¸ƒã‚’ç¶™ç¶šã—ã¾ã™ã‹ï¼Ÿ`);
            }
            
            // 1æ—¥1å›åˆ¶é™ãƒã‚§ãƒƒã‚¯
            const todayDistribution = currentData.find(member => 
                member.id === cleanMemberId && member.date === today
            );
            
            if (todayDistribution) {
                showError(`ä¼šå“¡ç•ªå· ${cleanMemberId} ã¯æœ¬æ—¥æ—¢ã«ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚ï¼ˆé…å¸ƒæ™‚åˆ»: ${todayDistribution.timestamp}ï¼‰`);
                return;
            }
            
            // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (isTestMode && !systemSettings.allowDuplicateInTest) {
                const isDuplicate = currentData.some(member => member.id === cleanMemberId);
                if (isDuplicate) {
                    showError(`ä¼šå“¡ç•ªå· ${cleanMemberId} ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰`);
                    return;
                }
            }
            
            // é…å¸ƒå‡¦ç†
            const memberData = {
                id: cleanMemberId,
                timestamp: getCurrentTime(),
                date: today,
                testMode: isTestMode
            };
            
            if (isTestMode) {
                testDistributedMembers.push(memberData);
                localStorage.setItem('testDistributedMembers', JSON.stringify(testDistributedMembers));
            } else {
                distributedMembers.push(memberData);
                localStorage.setItem('distributedMembers', JSON.stringify(distributedMembers));
            }
            
            // ç”»é¢æ›´æ–°
            updateStats();
            updateHistory();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            const modeText = isTestMode ? 'ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰' : '';
            showSuccess(`ä¼šå“¡ç•ªå· ${cleanMemberId} ã«ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’é…å¸ƒã—ã¾ã—ãŸã€‚${modeText}`);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            if (!isQRMode) {
                memberIdInput.value = '';
                memberIdInput.focus();
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šä¿å­˜
        function saveEventSettings() {
            eventSettings.name = document.getElementById('eventName').value;
            eventSettings.date = document.getElementById('eventDate').value;
            eventSettings.venue = document.getElementById('eventVenue').value;
            
            localStorage.setItem('eventSettings', JSON.stringify(eventSettings));
            updateEventDisplay();
            showSuccess('ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šä¿å­˜
        function saveSystemSettings() {
            systemSettings.strictDateCheck = document.getElementById('strictDateCheck').checked;
            systemSettings.allowDuplicateInTest = document.getElementById('allowDuplicateInTest').checked;
            
            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            showSuccess('ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }
        
        // å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        function clearHistory() {
            const modeText = isTestMode ? 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®' : '';
            if (confirm(`${modeText}é…å¸ƒå±¥æ­´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ`)) {
                if (isTestMode) {
                    testDistributedMembers = [];
                    localStorage.setItem('testDistributedMembers', JSON.stringify(testDistributedMembers));
                } else {
                    distributedMembers = [];
                    localStorage.setItem('distributedMembers', JSON.stringify(distributedMembers));
                }
                
                updateStats();
                updateHistory();
                hideMessages();
                showSuccess(`${modeText}é…å¸ƒå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚`);
            }
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function exportCSV() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const csvContent = generateCSVContent();
            const fileName = isTestMode ? 'postcard_distribution_test.csv' : 'postcard_distribution.csv';
            downloadFile(csvContent, fileName, 'text/csv');
            showSuccess('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }
        
        // è©³ç´°CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function exportDetailedCSV() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const csvContent = generateDetailedCSVContent();
            const fileName = isTestMode ? 'postcard_distribution_detailed_test.csv' : 'postcard_distribution_detailed.csv';
            downloadFile(csvContent, fileName, 'text/csv');
            showSuccess('è©³ç´°CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function exportText() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const textContent = generateTextContent();
            const fileName = isTestMode ? 'postcard_distribution_test.txt' : 'postcard_distribution.txt';
            downloadFile(textContent, fileName, 'text/plain');
            showSuccess('ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }
        
        // ä¼šå“¡ç•ªå·ã®ã¿ã‚’å‡ºåŠ›
        function exportMemberListOnly() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const memberIds = currentData.map(member => member.id).join('\n');
            const fileName = isTestMode ? 'member_ids_only_test.txt' : 'member_ids_only.txt';
            downloadFile(memberIds, fileName, 'text/plain');
            showSuccess('ä¼šå“¡ç•ªå·ãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            if (currentData.length === 0) {
                showError('é…å¸ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const textContent = generateTextContent();
            navigator.clipboard.writeText(textContent).then(() => {
                showSuccess('é…å¸ƒå±¥æ­´ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
            }).catch(() => {
                showError('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }
        
        // CSVå†…å®¹ã‚’ç”Ÿæˆ
        function generateCSVContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const header = 'ä¼šå“¡ç•ªå·,é…å¸ƒæ—¥æ™‚,é…å¸ƒæ—¥\n';
            const rows = currentData.map(member => 
                `${member.id},"${member.timestamp}","${member.date}"`
            ).join('\n');
            return header + rows;
        }
        
        // è©³ç´°CSVå†…å®¹ã‚’ç”Ÿæˆ
        function generateDetailedCSVContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const currentTime = getCurrentTime();
            const modeText = isTestMode ? ' (ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰)' : '';
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            const header = 'ä¼šå“¡ç•ªå·,é…å¸ƒæ—¥æ™‚,é…å¸ƒæ—¥,é…å¸ƒé †åº,ãƒ¢ãƒ¼ãƒ‰\n';
            const rows = currentData.map((member, index) => 
                `${member.id},"${member.timestamp}","${member.date}",${index + 1},${member.testMode ? 'ãƒ†ã‚¹ãƒˆ' : 'æœ¬ç•ª'}`
            ).join('\n');
            
            let content = `# ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒå±¥æ­´${modeText} - ${currentTime}\n`;
            content += `# ã‚¤ãƒ™ãƒ³ãƒˆå: ${eventSettings.name || 'æœªè¨­å®š'}\n`;
            content += `# ã‚¤ãƒ™ãƒ³ãƒˆæ—¥: ${eventSettings.date || 'æœªè¨­å®š'}\n`;
            content += `# ä¼šå ´: ${eventSettings.venue || 'æœªè¨­å®š'}\n`;
            content += `# æœ¬æ—¥ã®é…å¸ƒæ•°: ${todayData.length}æš\n`;
            content += `# ç·é…å¸ƒæ•°: ${currentData.length}æš\n\n`;
            content += header + rows;
            
            return content;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’ç”Ÿæˆ
        function generateTextContent() {
            const currentData = isTestMode ? testDistributedMembers : distributedMembers;
            const currentTime = getCurrentTime();
            const modeText = isTestMode ? ' (ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰)' : '';
            const today = getTodayString();
            const todayData = currentData.filter(member => member.date === today);
            
            let content = `ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰é…å¸ƒå±¥æ­´${modeText}\n`;
            content += `å‡ºåŠ›æ—¥æ™‚: ${currentTime}\n`;
            content += `ã‚¤ãƒ™ãƒ³ãƒˆå: ${eventSettings.name || 'æœªè¨­å®š'}\n`;
            content += `ã‚¤ãƒ™ãƒ³ãƒˆæ—¥: ${eventSettings.date || 'æœªè¨­å®š'}\n`;
            content += `ä¼šå ´: ${eventSettings.venue || 'æœªè¨­å®š'}\n`;
            content += `æœ¬æ—¥ã®é…å¸ƒæ•°: ${todayData.length}æš\n`;
            content += `ç·é…å¸ƒæ•°: ${currentData.length}æš\n\n`;
            content += `--- é…å¸ƒå±¥æ­´ ---\n`;
            
            currentData.forEach((member, index) => {
                const mode = member.testMode ? ' (ãƒ†ã‚¹ãƒˆ)' : '';
                content += `${index + 1}. ä¼šå“¡ç•ªå·: ${member.id} | é…å¸ƒæ—¥æ™‚: ${member.timestamp} | æ—¥ä»˜: ${member.date}${mode}\n`;
            });
            
            content += `\n--- ä¼šå“¡ç•ªå·ä¸€è¦§ ---\n`;
            content += currentData.map(member => member.id).join('\n');
            
            return content;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!isQRMode) {
                const memberId = memberIdInput.value.trim();
                processMemberRegistration(memberId);
            }
        });
        
        // å…¥åŠ›æ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        memberIdInput.addEventListener('input', hideMessages);
    </script>
</body>
</html>